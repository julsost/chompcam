<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herbivory Tracking Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #2c3e50; }
        .container { display: flex; height: 100vh; overflow: hidden; }
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .side-panel { width: 350px; background: white; border-left: 2px solid #e1e8ed; display: flex; flex-direction: column; overflow: hidden; }
        header { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #1a5490; margin-bottom: 20px; font-size: 24px; }
        .metadata-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-size: 12px; font-weight: 600; color: #5a6c7d; margin-bottom: 5px; text-transform: uppercase; }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"] { padding: 10px; border: 2px solid #e1e8ed; border-radius: 6px; font-size: 14px; }
        input:focus { outline: none; border-color: #3498db; }
        .video-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #videoContainer { position: relative; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 15px; min-height: 300px; display: flex; align-items: center; justify-content: center; }
        #videoContainer.empty::after { content: "Upload a video to begin"; color: #666; font-size: 18px; }
        video { width: 100%; display: block; }
        .video-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 15px; }
        button { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        button:hover { background: #2980b9; }
        button.secondary { background: #95a5a6; }
        button.secondary:hover { background: #7f8c8d; }
        button.success { background: #27ae60; }
        button.success:hover { background: #229954; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        select { padding: 10px; border: 2px solid #e1e8ed; border-radius: 6px; font-size: 14px; background: white; }
        input[type="range"] { width: 100%; height: 8px; border-radius: 5px; background: #e1e8ed; -webkit-appearance: none; margin: 10px 0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #3498db; cursor: pointer; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; }
        input[type="checkbox"] { width: 18px; height: 18px; }
        .side-panel-header { padding: 20px; background: #1a5490; color: white; }
        .side-panel-header h2 { font-size: 18px; margin-bottom: 15px; }
        .new-fish-section { padding: 15px; background: #f8f9fa; border-bottom: 2px solid #e1e8ed; }
        .species-search { width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 6px; margin-bottom: 10px; font-size: 14px; }
        .species-slideshow { max-height: 300px; overflow-y: auto; border: 2px solid #e1e8ed; border-radius: 6px; background: white; margin-bottom: 10px; }
        .species-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #e1e8ed; transition: background 0.2s; display: flex; align-items: center; gap: 10px; }
        .species-item:hover { background: #f0f8ff; }
        .species-item.selected { background: #e3f2fd; font-weight: 600; }
        .species-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; background: #e1e8ed; flex-shrink: 0; border: 1px solid #ccc; }
        .species-img-placeholder { width: 50px; height: 50px; border-radius: 4px; background: #e1e8ed; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #999; font-size: 20px; }
        .species-info { flex: 1; min-width: 0; }
        .fish-list { flex: 1; overflow-y: auto; padding: 15px; }
        .fish-card { background: white; border: 2px solid #e1e8ed; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .fish-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .fish-name { font-weight: 600; font-size: 16px; color: #1a5490; }
        .fish-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 2px solid #e1e8ed; margin-bottom: 10px; }
        .fish-card-top { display: flex; gap: 12px; align-items: flex-start; }
        .fish-card-details { flex: 1; }
        .fish-stats { display: flex; gap: 15px; margin-bottom: 10px; font-size: 14px; }
        .stat { display: flex; flex-direction: column; }
        .stat-label { font-size: 11px; color: #7f8c8d; text-transform: uppercase; }
        .stat-value { font-weight: 600; font-size: 18px; color: #2c3e50; }
        .maxn-badge { background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .fish-actions { display: flex; gap: 8px; }
        .fish-actions button { padding: 8px 12px; font-size: 13px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 20px; color: #1a5490; }
        .close-modal { background: none; color: #95a5a6; font-size: 28px; padding: 0; width: 30px; height: 30px; }
        .notification { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 2000; display: none; }
        .notification.active { display: block; }
        .notification.warning { background: #f39c12; }
        .notification.error { background: #e74c3c; }
        .export-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .export-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .time-display { font-family: monospace; font-size: 16px; font-weight: 600; padding: 8px; background: #f8f9fa; border-radius: 4px; }
        .shortcuts { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; font-size: 12px; }
        .shortcuts h4 { margin-bottom: 10px; color: #1a5490; }
        .shortcut { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .key { background: #e1e8ed; padding: 2px 8px; border-radius: 4px; font-family: monospace; }
        .crop-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; cursor: crosshair; }
        .crop-box { position: absolute; border: 2px dashed #3498db; background: rgba(52,152,219,0.2); }
        @media (max-width: 1024px) { .container { flex-direction: column; } .side-panel { width: 100%; max-height: 400px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <header>
                <h1>üê† Herbivory Tracking Tool</h1>
                <div class="metadata-grid">
                    <div class="form-group"><label>Location</label><input type="text" id="location" placeholder="e.g., Moreton Bay"></div>
                    <div class="form-group"><label>Date</label><input type="date" id="date"></div>
                    <div class="form-group"><label>Time</label><input type="time" id="time"></div>
                    <div class="form-group"><label>Transect #</label><input type="text" id="transect" placeholder="e.g., T1"></div>
                    <div class="form-group"><label>Reviewer</label><input type="text" id="reviewer" placeholder="Your name"></div>
                    <div class="form-group"><label>Video Filename</label><input type="text" id="videoFilename" placeholder="Auto-filled"></div>
                </div>
                <input type="file" id="videoInput" accept="video/*" style="display:none">
                <button onclick="document.getElementById('videoInput').click()">üìπ Choose Video File</button>
            </header>
            <div class="video-section">
                <div id="videoContainer" class="empty">
                    <video id="videoPlayer"></video>
                    <div class="crop-overlay" id="cropOverlay"><div class="crop-box" id="cropBox"></div></div>
                </div>
                <input type="range" id="videoScrubber" min="0" max="100" value="0" step="0.01">
                <div class="time-display"><span id="currentTime">00:00:00</span> / <span id="totalTime">00:00:00</span></div>
                <div class="video-controls">
                    <button id="playPauseBtn">‚ñ∂Ô∏è Play</button>
                    <button id="stepBackBtn">‚èÆÔ∏è -1</button>
                    <button id="stepForwardBtn">‚è≠Ô∏è +1</button>
                    <select id="speedSelect">
                        <option value="1">1x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                        <option value="3">3x</option>
                        <option value="4">4x</option>
                        <option value="5">5x</option>
                    </select>
                    <button id="screenshotBtn" class="secondary">üì∏ Screenshot</button>
                    <button id="cropScreenshotBtn" class="secondary">‚úÇÔ∏è Crop</button>
                    <div class="checkbox-group">
                        <input type="checkbox" id="autoAdvance">
                        <label style="text-transform:none;margin:0">Auto-advance</label>
                    </div>
                </div>
                <div class="shortcuts">
                    <h4>‚å®Ô∏è Shortcuts</h4>
                    <div class="shortcut"><span>Play/Pause</span><span class="key">Space</span></div>
                    <div class="shortcut"><span>Step Back/Forward</span><span class="key">‚Üê ‚Üí</span></div>
                    <div class="shortcut"><span>Screenshot</span><span class="key">S</span></div>
                </div>
            </div>
            <div class="export-section">
                <h2 style="margin-bottom:15px">üìä Export Data</h2>
                <div class="export-buttons">
                    <button id="exportCSV" class="success">üíæ Export CSV</button>
                    <button id="exportZIP" class="success">üì¶ Export ZIP</button>
                </div>
            </div>
        </div>
        <div class="side-panel">
            <div class="side-panel-header">
                <h2>Fish Log</h2>
                <button id="newFishBtn" class="success" style="width:100%">‚ûï New Fish/Species</button>
            </div>
            <div class="fish-list" id="fishList">
                <p style="text-align:center;color:#95a5a6;padding:20px">No fish logged yet</p>
            </div>
        </div>
    </div>
    <div class="modal" id="newFishModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add New Fish</h3><button class="close-modal" onclick="closeModal('newFishModal')">&times;</button></div>
            <label>Search Species</label>
            <input type="text" class="species-search" id="speciesSearch" placeholder="Type to search...">
            <div class="species-slideshow" id="speciesSlideshow"></div>
            <div style="margin:15px 0;text-align:center;color:#95a5a6">‚Äî OR ‚Äî</div>
            <label>Manual Entry</label>
            <input type="text" id="manualSpeciesName" placeholder="Type fish name">
            <button id="selectUnknown" class="secondary" style="width:100%;margin:15px 0">‚ùì Unknown Species</button>
            <div class="form-group" style="margin-bottom:15px">
                <label>How many fish? (This will be the initial MaxN)</label>
                <input type="number" id="initialFishCount" value="1" min="1" style="width:100%">
            </div>
            <button id="addFishBtn" class="success" style="width:100%">‚úÖ Add Fish</button>
        </div>
    </div>
    <div class="modal" id="biteModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Log Bite</h3><button class="close-modal" onclick="closeModal('biteModal')">&times;</button></div>
            <label>What substrate did the fish bite?</label>
            <select id="biteTarget" style="width:100%;margin-top:5px">
                <option value="">-- Select substrate --</option>
                <option value="Algae">Algae</option>
                <option value="Coral">Coral</option>
                <option value="Sand">Sand</option>
            </select>
            <button id="saveBiteBtn" class="success" style="width:100%;margin-top:15px">‚úÖ Save</button>
        </div>
    </div>
    <div class="modal" id="countModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Log Additional Fish</h3><button class="close-modal" onclick="closeModal('countModal')">&times;</button></div>
            <label>How many additional fish?</label>
            <input type="number" id="additionalCount" value="1" min="1">
            <button id="saveCountBtn" class="success" style="width:100%;margin-top:15px">‚úÖ Save</button>
        </div>
    </div>
    <div class="modal" id="maxnModal">
        <div class="modal-content">
            <div class="modal-header"><h3>üéØ New MaxN!</h3><button class="close-modal" onclick="closeModal('maxnModal')">&times;</button></div>
            <p style="margin-bottom:15px">New MaxN for <strong id="maxnSpeciesName"></strong>: <strong id="maxnValue"></strong></p>
            <p style="margin-bottom:20px">Capture a screenshot showing all fish?</p>
            <button id="captureMaxnScreenshot" class="success" style="width:100%;margin-bottom:10px">üì∏ Take Screenshot</button>
            <button onclick="closeModal('maxnModal')" class="secondary" style="width:100%">Skip</button>
        </div>
    </div>
    <div class="modal" id="firstSightingModal">
        <div class="modal-content">
            <div class="modal-header"><h3>üì∏ Capture Fish Photo</h3><button class="close-modal" onclick="skipFirstSightingPhoto()">&times;</button></div>
            <p style="margin-bottom:15px">Take a cropped screenshot of <strong id="firstSightingSpecies"></strong> for identification.</p>
            <p style="margin-bottom:20px;color:#7f8c8d;font-size:13px">Click and drag on the video to crop around the fish.</p>
            <button id="startFirstSightingCrop" class="success" style="width:100%;margin-bottom:10px">‚úÇÔ∏è Crop Screenshot</button>
            <button id="takeFullFirstSighting" class="secondary" style="width:100%;margin-bottom:10px">üì∏ Full Screenshot</button>
            <button onclick="skipFirstSightingPhoto()" class="secondary" style="width:100%">Skip</button>
        </div>
    </div>
    <div class="notification" id="notification"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // State
        const state = { fishLog: [], screenshots: [], events: [], currentFishId: null, selectedSpecies: null, cropMode: false, cropStart: null, pendingFish: null, firstSightingCropMode: false };
        
        // Species Data - images are in fish_species/ folder, named like bengal_sergeant.png
        const speciesData = [
            { name: "Bengal sergeant", scientific: "Abudefduf bengalensis", image: "bengal_sergeant.jpg" },
            { name: "Scissortail sergeant", scientific: "Abudefduf sexfasciatus", image: "scissortail_sergeant.png" },
            { name: "Whitley's Sergeant", scientific: "Abudefduf whitleyi", image: "whitleys_sergeant.png" },
            { name: "Sand Whiting", scientific: "Sillago Ciliata", image: "sand_whiting.png" },
            { name: "Trumpeter whiting", scientific: "Sillago maculata", image: "trumpeter_whiting.png" },
            { name: "Paradise Threadfin Bream", scientific: "", image: "paradise_threadfin_bream.png" },
            { name: "Yellowfin Bream", scientific: "Acanthopagrus australis", image: "yellowfin_bream.png" },
            { name: "Grass emperor", scientific: "Lethrinus laticaudis", image: "grass_emperor.png" },
            { name: "Threadfin emperor", scientific: "Lethrinus genivittatus", image: "threadfin_emperor.png" },
            { name: "Lined fangblenny", scientific: "", image: "lined_fangblenny.png" },
            { name: "Yellow sabretooth blenny", scientific: "", image: "yellow_sabretooth_blenny.png" },
            { name: "Bluestriped fangblenny", scientific: "", image: "bluestriped_fangblenny.png" },
            { name: "Sea Garfish", scientific: "Hyporhamphus quoyi", image: "sea_garfish.png" },
            { name: "Silver Batfish", scientific: "Monodactylus argenteus", image: "silver_batfish.png" },
            { name: "Black rabbitfish", scientific: "Siganus fuscescens", image: "black_rabbitfish.png" },
            { name: "Golden Trevally", scientific: "Gnathanodon speciosus", image: "golden_trevally.png" },
            { name: "Bigeye trevally", scientific: "Caranx sexfasciatus", image: "bigeye_trevally.png" },
            { name: "Giant trevally", scientific: "", image: "giant_trevally.png" },
            { name: "Blacktip silverbiddy", scientific: "Gerres oyena", image: "blacktip_silverbiddy.png" },
            { name: "Common silverbiddy", scientific: "Gerres subfasciatus", image: "common_silverbiddy.png" },
            { name: "Gunther's Wrasse", scientific: "Pseudolabrus guentheri", image: "gunthers_wrasse.png" },
            { name: "Moon wrasse", scientific: "Thalassoma lunare", image: "moon_wrasse.png" },
            { name: "Rainbow wrasse", scientific: "", image: "rainbow_wrasse.png" },
            { name: "Bluebarred Parrotfish", scientific: "Scarrus ghoban", image: "bluebarred_parrotfish.png" },
            { name: "Port Jackson Glassfish", scientific: "Ambassis jacksoniensis", image: "port_jackson_glassfish.png" },
            { name: "Common cleanerfish", scientific: "Labroides dimidiatus", image: "common_cleanerfish.png" },
            { name: "Chinese demoiselle", scientific: "Neopomaentrus bankieri", image: "chinese_demoiselle.png" },
            { name: "Neon damsel", scientific: "Pomacentrus coelestis", image: "neon_damsel.png" },
            { name: "Yellowtail blue damsel", scientific: "", image: "yellowtail_blue_damsel.png" },
            { name: "Australian damsel", scientific: "Pomacentrus australis", image: "australian_damsel.png" },
            { name: "Golden damsel", scientific: "Amblyglyphidodon aureus", image: "golden_damsel.png" },
            { name: "Lemon damsel", scientific: "Pomacentrus moluccensis", image: "lemon_damsel.png" },
            { name: "Whiteband damsel", scientific: "Plectroglyphidodon leucozonus", image: "whiteband_damsel.png" },
            { name: "Yellowtail angelfish", scientific: "Chaetodontoplus meredithi", image: "yellowtail_angelfish.png" },
            { name: "Dusky Butterflyfish", scientific: "Chaetodon flavirostris", image: "dusky_butterflyfish.png" },
            { name: "Moses' snapper", scientific: "Lutjanus russellii", image: "moses_snapper.png" },
            { name: "Blackspot snapper", scientific: "Lutjanus fulviflamma", image: "blackspot_snapper.png" },
            { name: "Stripey", scientific: "Microcanthus strigatus", image: "stripey.png" },
            { name: "East-Australian Stripey", scientific: "Microcanthus joyceae", image: "east_australian_stripey.png" },
            { name: "Sydney Cardinalfish", scientific: "Ostorhinchus limenus", image: "sydney_cardinalfish.png" },
            { name: "Whiteline Cardinalfish", scientific: "Ostorhinchus cavitensis", image: "whiteline_cardinalfish.png" },
            { name: "Cook's cardinalfish", scientific: "Ostorhinchus cookii", image: "cooks_cardinalfish.png" },
            { name: "Keyhole angelfish", scientific: "Centropyge tibicen", image: "keyhole_angelfish.png" },
            { name: "Pencil surgeonfish", scientific: "Acanthurus dussumieri", image: "pencil_surgeonfish.png" },
            { name: "Crested moorwong", scientific: "Goniistius vestitus", image: "crested_moorwong.png" },
            { name: "Blacksaddle goatfish", scientific: "", image: "blacksaddle_goatfish.png" },
            { name: "Striped barracuda", scientific: "", image: "striped_barracuda.png" },
            { name: "Eastern Striped Grunter", scientific: "Pelates sexlineatus", image: "eastern_striped_grunter.png" },
            { name: "Beaked coralfish", scientific: "Chelmon rostratus", image: "beaked_coralfish.png" },
            { name: "Common hardyhead", scientific: "Atherinomorus vaigiensis", image: "common_hardyhead.png" },
            { name: "Barred yellowtail scad", scientific: "Atule mate", image: "barred_yellowtail_scad.png" }
        ];

        // Elements
        const video = document.getElementById('videoPlayer');
        const scrubber = document.getElementById('videoScrubber');
        const container = document.getElementById('videoContainer');
        const cropOverlay = document.getElementById('cropOverlay');
        const cropBox = document.getElementById('cropBox');

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadSession();
            populateSpecies();
            setupEvents();
            setDefaults();
        });

        function setDefaults() {
            const now = new Date();
            document.getElementById('date').valueAsDate = now;
            document.getElementById('time').value = now.toTimeString().slice(0,5);
        }

        function setupEvents() {
            document.getElementById('videoInput').onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    video.src = URL.createObjectURL(file);
                    document.getElementById('videoFilename').value = file.name;
                    container.classList.remove('empty');
                    notify('Video loaded!');
                }
            };
            video.onloadedmetadata = () => {
                scrubber.max = video.duration;
                document.getElementById('totalTime').textContent = formatTime(video.duration);
            };
            video.ontimeupdate = () => {
                scrubber.value = video.currentTime;
                document.getElementById('currentTime').textContent = formatTime(video.currentTime);
            };
            document.getElementById('playPauseBtn').onclick = togglePlay;
            document.getElementById('stepBackBtn').onclick = () => video.currentTime = Math.max(0, video.currentTime - 1/30);
            document.getElementById('stepForwardBtn').onclick = () => video.currentTime = Math.min(video.duration, video.currentTime + 1/30);
            document.getElementById('speedSelect').onchange = e => video.playbackRate = parseFloat(e.target.value);
            scrubber.oninput = () => video.currentTime = parseFloat(scrubber.value);
            document.getElementById('screenshotBtn').onclick = () => takeScreenshot();
            document.getElementById('cropScreenshotBtn').onclick = startCrop;
            document.getElementById('newFishBtn').onclick = () => openModal('newFishModal');
            document.getElementById('speciesSearch').oninput = filterSpecies;
            document.getElementById('selectUnknown').onclick = () => {
                document.getElementById('manualSpeciesName').value = '';
                document.getElementById('manualSpeciesName').placeholder = 'e.g., white fish with blue stripe';
                document.getElementById('manualSpeciesName').focus();
                state.selectedSpecies = null;
                notify('Enter a description to identify this fish later', 'warning');
            };
            document.getElementById('addFishBtn').onclick = addFish;
            document.getElementById('saveBiteBtn').onclick = saveBite;
            document.getElementById('saveCountBtn').onclick = saveCount;
            document.getElementById('captureMaxnScreenshot').onclick = captureMaxN;
            document.getElementById('exportCSV').onclick = exportCSV;
            document.getElementById('exportZIP').onclick = exportZIP;
            document.getElementById('startFirstSightingCrop').onclick = startFirstSightingCrop;
            document.getElementById('takeFullFirstSighting').onclick = () => takeFirstSightingScreenshot(null);
            cropOverlay.onmousedown = e => { state.cropStart = { x: e.offsetX, y: e.offsetY }; };
            cropOverlay.onmousemove = e => {
                if (!state.cropStart) return;
                const x = Math.min(state.cropStart.x, e.offsetX);
                const y = Math.min(state.cropStart.y, e.offsetY);
                cropBox.style.left = x + 'px';
                cropBox.style.top = y + 'px';
                cropBox.style.width = Math.abs(e.offsetX - state.cropStart.x) + 'px';
                cropBox.style.height = Math.abs(e.offsetY - state.cropStart.y) + 'px';
                cropBox.style.display = 'block';
            };
            cropOverlay.onmouseup = e => {
                if (!state.cropStart) return;
                const rect = video.getBoundingClientRect();
                const scaleX = video.videoWidth / rect.width;
                const scaleY = video.videoHeight / rect.height;
                const crop = {
                    x: Math.min(state.cropStart.x, e.offsetX) * scaleX,
                    y: Math.min(state.cropStart.y, e.offsetY) * scaleY,
                    width: Math.abs(e.offsetX - state.cropStart.x) * scaleX,
                    height: Math.abs(e.offsetY - state.cropStart.y) * scaleY
                };
                
                if (state.firstSightingCropMode) {
                    takeFirstSightingScreenshot(crop);
                    state.firstSightingCropMode = false;
                } else {
                    takeScreenshot(crop);
                }
                
                state.cropStart = null;
                cropOverlay.style.display = 'none';
                cropBox.style.display = 'none';
            };
            document.onkeydown = e => {
                if (e.target.tagName === 'INPUT') return;
                if (e.key === ' ') { e.preventDefault(); togglePlay(); }
                if (e.key === 'ArrowLeft') { e.preventDefault(); video.currentTime -= 1/30; }
                if (e.key === 'ArrowRight') { e.preventDefault(); video.currentTime += 1/30; }
                if (e.key.toLowerCase() === 's') { e.preventDefault(); takeScreenshot(); }
            };
            setInterval(saveSession, 30000);
        }

        function togglePlay() {
            if (video.paused) { video.play(); document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è Pause'; }
            else { video.pause(); document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è Play'; }
        }

        function formatTime(s) {
            const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        }

        function startCrop() {
            state.firstSightingCropMode = false;
            cropOverlay.style.display = 'block';
            notify('Click and drag to select area', 'warning');
        }
        
        function startFirstSightingCrop() {
            closeModal('firstSightingModal');
            state.firstSightingCropMode = true;
            cropOverlay.style.display = 'block';
            notify('Click and drag to crop around the fish', 'warning');
        }

        function takeScreenshot(crop) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if (crop) {
                canvas.width = crop.width; canvas.height = crop.height;
                ctx.drawImage(video, crop.x, crop.y, crop.width, crop.height, 0, 0, crop.width, crop.height);
            } else {
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
            }
            const data = canvas.toDataURL('image/png');
            const filename = `screenshot_${String(state.screenshots.length + 1).padStart(3,'0')}.png`;
            state.screenshots.push({ filename, data, timestamp: video.currentTime });
            notify('Screenshot captured!');
            return filename;
        }

        function populateSpecies() {
            const ss = document.getElementById('speciesSlideshow');
            ss.innerHTML = speciesData.map((s,i) => `<div class="species-item" data-idx="${i}">
                <img class="species-img" src="fish_species/${s.image}" alt="${s.name}" onerror="this.outerHTML='<div class=\\'species-img-placeholder\\'>üêü</div>'">
                <div class="species-info"><strong>${s.name}</strong><br><small style="color:#7f8c8d">${s.scientific || 'Unknown'}</small></div>
            </div>`).join('');
            ss.querySelectorAll('.species-item').forEach(el => {
                el.onclick = function() {
                    ss.querySelectorAll('.species-item').forEach(e => e.classList.remove('selected'));
                    this.classList.add('selected');
                    state.selectedSpecies = speciesData[this.dataset.idx];
                };
            });
        }

        function filterSpecies() {
            const term = document.getElementById('speciesSearch').value.toLowerCase();
            document.querySelectorAll('.species-item').forEach(el => {
                el.style.display = el.textContent.toLowerCase().includes(term) ? 'block' : 'none';
            });
        }

        function addFish() {
            const manual = document.getElementById('manualSpeciesName').value.trim();
            const name = state.selectedSpecies?.name || manual;
            if (!name) { notify('Select or enter species', 'error'); return; }
            
            const initialCount = parseInt(document.getElementById('initialFishCount').value) || 1;
            if (initialCount < 1) { notify('Count must be at least 1', 'error'); return; }
            
            const fish = { id: Date.now(), species: name, count: initialCount, maxN: initialCount, bites: 0, firstSeen: video.currentTime, events: [], thumbnail: null };
            const evt = { timestamp: video.currentTime, frame: Math.floor(video.currentTime*30), species: name, type: 'first_sighting', countAdded: initialCount, cumulative: initialCount, maxN: initialCount, bite: '', screenshot: '', notes: '' };
            
            // Store pending fish data
            state.pendingFish = { fish, evt };
            
            // Close the new fish modal
            closeModal('newFishModal');
            state.selectedSpecies = null;
            document.getElementById('manualSpeciesName').value = '';
            document.getElementById('manualSpeciesName').placeholder = 'Type fish name';
            document.getElementById('speciesSearch').value = '';
            document.getElementById('initialFishCount').value = '1';
            document.querySelectorAll('.species-item').forEach(e => e.classList.remove('selected'));
            
            // Show first sighting screenshot modal
            document.getElementById('firstSightingSpecies').textContent = name;
            openModal('firstSightingModal');
        }
        
        function completeAddFish(thumbnailData, screenshotFilename) {
            const { fish, evt } = state.pendingFish;
            
            if (thumbnailData) {
                fish.thumbnail = thumbnailData;
            }
            if (screenshotFilename) {
                evt.screenshot = screenshotFilename;
            }
            
            state.fishLog.push(fish);
            state.events.push(evt);
            fish.events.push(evt);
            
            state.pendingFish = null;
            renderFish();
            notify(`Added ${fish.species}!`);
            if (document.getElementById('autoAdvance').checked) video.currentTime += 1/30;
            saveSession();
        }
        
        function skipFirstSightingPhoto() {
            closeModal('firstSightingModal');
            if (state.pendingFish) {
                completeAddFish(null, null);
            }
        }
        
        function takeFirstSightingScreenshot(crop) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if (crop) {
                canvas.width = crop.width; canvas.height = crop.height;
                ctx.drawImage(video, crop.x, crop.y, crop.width, crop.height, 0, 0, crop.width, crop.height);
            } else {
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
            }
            const data = canvas.toDataURL('image/png');
            const filename = `screenshot_${String(state.screenshots.length + 1).padStart(3,'0')}.png`;
            state.screenshots.push({ filename, data, timestamp: video.currentTime });
            
            closeModal('firstSightingModal');
            completeAddFish(data, filename);
            notify('Fish photo captured!');
        }

        function renderFish() {
            const list = document.getElementById('fishList');
            if (!state.fishLog.length) { list.innerHTML = '<p style="text-align:center;color:#95a5a6;padding:20px">No fish logged yet</p>'; return; }
            list.innerHTML = state.fishLog.map(f => `
                <div class="fish-card">
                    <div class="fish-card-top">
                        ${f.thumbnail ? `<img class="fish-thumbnail" src="${f.thumbnail}" alt="${f.species}">` : ''}
                        <div class="fish-card-details">
                            <div class="fish-card-header"><span class="fish-name">${f.species}</span><span class="maxn-badge">MaxN: ${f.maxN}</span></div>
                            <div class="fish-stats">
                                <div class="stat"><span class="stat-label">Count</span><span class="stat-value">${f.count}</span></div>
                                <div class="stat"><span class="stat-label">Bites</span><span class="stat-value">${f.bites}</span></div>
                                <div class="stat"><span class="stat-label">First</span><span class="stat-value" style="font-size:14px">${formatTime(f.firstSeen)}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="fish-actions">
                        <button class="secondary" onclick="logBite(${f.id})">ü¶∑ Bite</button>
                        <button class="success" onclick="logCount(${f.id})">‚ûï New</button>
                        <button class="danger" onclick="removeFish(${f.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function logBite(id) { state.currentFishId = id; openModal('biteModal'); }
        function saveBite() {
            const fish = state.fishLog.find(f => f.id === state.currentFishId);
            const target = document.getElementById('biteTarget').value;
            if (!target) { notify('Select a substrate type', 'error'); return; }
            fish.bites++;
            const evt = { timestamp: video.currentTime, frame: Math.floor(video.currentTime*30), species: fish.species, type: 'bite', countAdded: 0, cumulative: fish.count, maxN: fish.maxN, bite: target, screenshot: '', notes: '' };
            state.events.push(evt); fish.events.push(evt);
            renderFish(); closeModal('biteModal');
            document.getElementById('biteTarget').value = '';
            notify(`Bite logged: ${target}!`);
            if (document.getElementById('autoAdvance').checked) video.currentTime += 1/30;
            saveSession();
        }

        function logCount(id) { state.currentFishId = id; document.getElementById('additionalCount').value = 1; openModal('countModal'); }
        
        function saveCount() {
            const fish = state.fishLog.find(f => f.id === state.currentFishId);
            const add = parseInt(document.getElementById('additionalCount').value);
        
            if (add < 1) {
                notify('Count must be >= 1', 'error');
                return;
            }
        
            fish.count += add;
        
            // FIX: maxN should track the largest single observation (add), not cumulative
            const newMax = add > fish.maxN;
            if (newMax) fish.maxN = add;
        
            const evt = {
                timestamp: video.currentTime,
                frame: Math.floor(video.currentTime * 30),
                species: fish.species,
                type: 're_sighting',
                countAdded: add,
                cumulative: fish.count,
                maxN: fish.maxN,
                bite: '',
                screenshot: '',
                notes: ''
            };
        
            state.events.push(evt);
            fish.events.push(evt);
        
            renderFish();
            closeModal('countModal');
            notify(`Added ${add} ${fish.species}!`);
        
            if (newMax) {
                document.getElementById('maxnSpeciesName').textContent = fish.species;
                document.getElementById('maxnValue').textContent = fish.maxN;
                openModal('maxnModal');
            } else if (document.getElementById('autoAdvance').checked) {
                video.currentTime += 1 / 30;
            }
        
            saveSession();
        }
        function captureMaxN() {
            const fish = state.fishLog.find(f => f.id === state.currentFishId);
            const lastEvt = fish.events[fish.events.length - 1];
            lastEvt.screenshot = takeScreenshot();
            lastEvt.notes = 'MaxN screenshot';
            closeModal('maxnModal');
            if (document.getElementById('autoAdvance').checked) video.currentTime += 1/30;
            saveSession();
        }

        function removeFish(id) {
            if (!confirm('Remove this fish?')) return;
            const fish = state.fishLog.find(f => f.id === id);
            state.fishLog = state.fishLog.filter(f => f.id !== id);
            state.events = state.events.filter(e => e.species !== fish.species);
            renderFish(); notify('Removed'); saveSession();
        }

        function getMeta() {
            return { location: document.getElementById('location').value, date: document.getElementById('date').value, time: document.getElementById('time').value, transect: document.getElementById('transect').value, reviewer: document.getElementById('reviewer').value, videoFilename: document.getElementById('videoFilename').value };
        }

        function exportCSV() {
            const m = getMeta();
            let csv = 'Location,Date,Time,Transect,Reviewer,VideoFilename\n';
            csv += `"${m.location}","${m.date}","${m.time}","${m.transect}","${m.reviewer}","${m.videoFilename}"\n\n`;
            csv += 'Timestamp,FrameNumber,Species,EventType,CountAdded,CumulativeCount,CurrentMaxN,BiteTarget,ScreenshotFile,Notes\n';
            state.events.forEach(e => {
                csv += `"${formatTime(e.timestamp)}",${e.frame},"${e.species}","${e.type}",${e.countAdded},${e.cumulative},${e.maxN},"${e.bite}","${e.screenshot}","${e.notes}"\n`;
            });
            download(csv, 'herbivory-data.csv', 'text/csv');
            notify('CSV exported!');
        }

        async function exportZIP() {
            const m = getMeta();
            let csv = 'Location,Date,Time,Transect,Reviewer,VideoFilename\n';
            csv += `"${m.location}","${m.date}","${m.time}","${m.transect}","${m.reviewer}","${m.videoFilename}"\n\n`;
            csv += 'Timestamp,FrameNumber,Species,EventType,CountAdded,CumulativeCount,CurrentMaxN,BiteTarget,ScreenshotFile,Notes\n';
            state.events.forEach(e => {
                csv += `"${formatTime(e.timestamp)}",${e.frame},"${e.species}","${e.type}",${e.countAdded},${e.cumulative},${e.maxN},"${e.bite}","${e.screenshot}","${e.notes}"\n`;
            });
            const zip = new JSZip();
            zip.file('herbivory-data.csv', csv);
            const folder = zip.folder('screenshots');
            state.screenshots.forEach(s => folder.file(s.filename, s.data.split(',')[1], { base64: true }));
            const blob = await zip.generateAsync({ type: 'blob' });
            download(blob, 'herbivory-export.zip', 'application/zip');
            notify('ZIP exported!');
        }

        function download(content, name, type) {
            const blob = content instanceof Blob ? content : new Blob([content], { type });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function notify(msg, type = 'success') {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = 'notification active' + (type !== 'success' ? ' ' + type : '');
            setTimeout(() => n.classList.remove('active'), 3000);
        }

        function saveSession() {
            const data = { meta: getMeta(), fishLog: state.fishLog, events: state.events, screenshots: state.screenshots };
            localStorage.setItem('herbivoryTracker', JSON.stringify(data));
        }

        function loadSession() {
            const saved = localStorage.getItem('herbivoryTracker');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.meta) Object.keys(data.meta).forEach(k => { const el = document.getElementById(k); if (el) el.value = data.meta[k]; });
                    if (data.fishLog) state.fishLog = data.fishLog;
                    if (data.events) state.events = data.events;
                    if (data.screenshots) state.screenshots = data.screenshots;
                    renderFish();
                } catch (e) { console.error(e); }
            }
        }
    </script>
</body>
</html>
